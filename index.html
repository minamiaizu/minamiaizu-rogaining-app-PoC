<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É≠„Ç≤„Ç§„Éã„É≥„Ç∞ PoC</title>
    <!-- PWA „É°„Çø„Çø„Ç∞ -->
    <meta name="description" content="„Ç™„Éï„É©„Ç§„É≥ÂØæÂøú„ÅÆ„É≠„Ç≤„Ç§„Éã„É≥„Ç∞Á´∂ÊäÄÊîØÊè¥„Ç¢„Éó„É™">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="„É≠„Ç≤„Ç§„Éã„É≥„Ç∞">
    
    <!-- „Éû„Éã„Éï„Çß„Çπ„Éà -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOSÁî®„Ç¢„Ç§„Ç≥„É≥ -->
    <link rel="apple-touch-icon" href="icon-192.png">

    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
        }
        
        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #header h1 {
            font-size: 20px;
            margin-bottom: 8px;
        }
        
        #status {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            opacity: 0.9;
        }
        
        #map {
            width: 100%;
            height: 400px;
        }
        
        #controls {
            padding: 20px;
            background: white;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .button-primary {
            background: #667eea;
            color: white;
        }
        
        .button-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .button-success {
            background: #48bb78;
            color: white;
        }
        
        .button-success:hover {
            background: #38a169;
        }
        
        .button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        
        #photo-input {
            display: none;
        }
        
        #info {
            padding: 15px 20px;
            background: white;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #4a5568;
        }
        
        .info-value {
            color: #667eea;
            font-weight: 600;
        }
        
        #checkpoint-list {
            padding: 15px 20px;
            background: white;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .checkpoint-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            background: #f7fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .checkpoint-item.completed {
            background: #c6f6d5;
        }
        
        .checkpoint-item.near {
            background: #fed7d7;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .checkpoint-name {
            font-weight: 600;
        }
        
        .checkpoint-points {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .checkpoint-item.completed .checkpoint-points {
            background: #48bb78;
        }
        
        #debug {
            padding: 15px 20px;
            background: #2d3748;
            color: #e2e8f0;
            margin: 15px;
            border-radius: 12px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-line {
            padding: 2px 0;
        }
        
        #photo-gallery {
            padding: 15px 20px;
            background: white;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .photo-thumbnail {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .photo-thumbnail:hover {
            transform: scale(1.05);
        }
        
        .photo-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            font-size: 10px;
        }
        
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .photo-modal.active {
            display: flex;
        }
        
        .photo-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }
        
        .photo-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            z-index: 10000;
        }
        
        #tabs {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            position: relative;
            z-index: 1000;
        }
        
        .tab {
            flex: 1;
            padding: 8px;
            text-align: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            /* iOS „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàÊúÄÈÅ©Âåñ */
            -webkit-tap-highlight-color: transparent;
            pointer-events: auto;
            position: relative;
            z-index: 10;
        }
        
        .tab:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .tab:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.98);
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }
        
        #compass-view {
            display: none;
            width: 100%;
            height: calc(100vh - 200px); /* „Éò„ÉÉ„ÉÄ„ÉºÂàÜ„ÅÆ‰ΩôË£ï„ÇíÂ¢ó„ÇÑ„Åô */
            min-height: 400px;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 100%);
            position: relative;
            overflow: hidden;
            margin-top: 10px; /* „Éò„ÉÉ„ÉÄ„Éº„Å®„ÅÆÈñìÈöî„ÇíÁ¢∫‰øù */
        }
        
        #compass-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(85vw, 85vh, 400px);
            height: min(85vw, 85vh, 400px);
        }
        
        @media (max-width: 768px) {
            #compass-container {
                width: min(90vw, calc(100vh - 300px), 350px);
                height: min(90vw, calc(100vh - 300px), 350px);
            }
        }
        
        #compass-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at center, #ffffff 0%, #f7fafc 70%, #e2e8f0 100%);
            box-shadow: 
                0 0 0 3px #2d3748,
                0 0 0 6px #e2e8f0,
                0 8px 30px rgba(0, 0, 0, 0.3),
                inset 0 2px 10px rgba(255, 255, 255, 0.8),
                inset 0 -2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-out;
        }
        
        #compass-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            margin-left: -15px;
            margin-top: -15px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffd700 0%, #b8860b 100%);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.3),
                inset 0 1px 3px rgba(255, 255, 255, 0.5);
            z-index: 10;
        }
        
        #compass-center::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            margin-left: -4px;
            margin-top: -4px;
            border-radius: 50%;
            background: #2d3748;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .compass-direction {
            position: absolute;
            font-weight: 700;
            font-size: 22px;
            color: #2d3748;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
            font-family: 'Georgia', serif;
        }
        
        .compass-direction.north {
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            color: #c53030;
            font-size: 32px;
            text-shadow: 0 2px 4px rgba(197, 48, 48, 0.3), 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .compass-direction.east {
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
        }
        
        .compass-direction.south {
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .compass-direction.west {
            top: 50%;
            left: 8px;
            transform: translateY(-50%);
        }
        
        .compass-subdirection {
            position: absolute;
            font-weight: 600;
            font-size: 14px;
            color: #4a5568;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
            font-family: 'Georgia', serif;
        }
        
        #compass-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 140px;
            margin-left: -4px;
            margin-top: -70px;
            transform-origin: center center;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            z-index: 5;
        }
        
        .needle-north {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background: linear-gradient(to bottom, #c53030 0%, #e53e3e 50%, #9b2c2c 100%);
            clip-path: polygon(50% 0%, 20% 95%, 50% 100%, 80% 95%);
        }
        
        .needle-north::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            height: 40%;
            margin-left: -1px;
            background: rgba(255, 255, 255, 0.4);
        }
        
        .needle-south {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background: linear-gradient(to top, #4a5568 0%, #718096 50%, #2d3748 100%);
            clip-path: polygon(20% 5%, 50% 0%, 80% 5%, 50% 100%);
        }
        
        #heading-display {
            position: absolute;
            top: 60px; /* „Çø„Éñ„Ç®„É™„Ç¢„Åã„ÇâÂçÅÂàÜÈõ¢„Åô */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            pointer-events: none; /* „ÇØ„É™„ÉÉ„ÇØ„ÇíÈÄèÈÅé„Åï„Åõ„Çã */
        }
        
        @media (max-width: 768px) {
            #heading-display {
                top: 50px; /* „É¢„Éê„Ç§„É´„Åß„ÇÇ„Çø„Éñ„Åã„ÇâÈõ¢„Åô */
                font-size: 18px;
                padding: 8px 16px;
            }
        }
        
        #checkpoint-markers {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .checkpoint-marker {
            position: absolute;
            width: 36px;
            height: 36px;
            margin-left: -18px;
            margin-top: -18px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease-out;
            pointer-events: auto;
        }
        
        @media (max-width: 768px) {
            .checkpoint-marker {
                width: 32px;
                height: 32px;
                margin-left: -16px;
                margin-top: -16px;
                font-size: 12px;
            }
        }
        
        .checkpoint-marker.completed {
            background: #48bb78;
        }
        
        #distance-bar-container {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            z-index: 100;
        }
        
        @media (max-width: 768px) {
            #distance-bar-container {
                bottom: 10px;
                width: 95%;
            }
        }
        
        #distance-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #2d3748;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        #distance-bar {
            position: relative;
            height: 40px;
            border-radius: 20px;
            background: linear-gradient(to right, 
                hsl(240, 80%, 50%) 0%, 
                hsl(180, 80%, 50%) 25%,
                hsl(120, 80%, 50%) 50%, 
                hsl(60, 80%, 50%) 75%,
                hsl(0, 80%, 50%) 100%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            overflow: visible;
        }
        
        .distance-marker {
            position: absolute;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            top: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .distance-marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }
        
        .distance-marker.completed {
            background: #48bb78 !important;
        }
        
        .custom-tooltip {
            position: fixed;
            background: rgba(45, 55, 72, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            z-index: 10001;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            transform: translate(-50%, -100%);
            margin-top: -10px;
        }
        
        .custom-tooltip::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(45, 55, 72, 0.95);
        }

        /* „Ç§„É≥„Çπ„Éà„Éº„É´„Éê„Éä„ÉºÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        #install-banner {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            z-index: 9999;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
        
        #install-banner-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }
        
        #install-banner button {
            background: white;
            color: #667eea;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        
        #install-banner button:hover {
            background: #f7fafc;
        }
        
        #install-banner .close-btn {
            background: transparent;
            color: white;
            padding: 5px 10px;
            font-size: 20px;
        }
        
        /* CanvasË¶ÅÁ¥†„ÇíÊ≠£„Åó„ÅèÈÖçÁΩÆ */
        #compass-ticks {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
    </style>
</head>
<body>
    <!-- PWA„Ç§„É≥„Çπ„Éà„Éº„É´„Éê„Éä„Éº -->
    <div id="install-banner">
        <div id="install-banner-content">
            <span>„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Åó„Å¶„Ç™„Éï„É©„Ç§„É≥„Åß„ÇÇ‰ΩøÁî®„Åß„Åç„Åæ„Åô</span>
            <div style="display: flex; gap: 10px;">
                <button id="install-button">„Ç§„É≥„Çπ„Éà„Éº„É´</button>
                <button class="close-btn" id="close-install-banner">&times;</button>
            </div>
        </div>
    </div>
    

    <div id="header">
        <h1>üèÉ „É≠„Ç≤„Ç§„Éã„É≥„Ç∞ PoC</h1>
        <div id="tabs">
            <div class="tab active" id="tab-map" data-view="map">üó∫ „Éû„ÉÉ„Éó</div>
            <div class="tab" id="tab-compass" data-view="compass" style="display: none;">üß≠ „Ç≥„É≥„Éë„Çπ</div>
        </div>
        <div id="status">
            <span id="timer">ÊÆã„ÇäÊôÇÈñì: 02:00:00</span>
            <span id="score">ÂæóÁÇπ: 0ÁÇπ</span>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div id="compass-view">
        <div id="heading-display">Êñπ‰Ωç: ---¬∞</div>
        <div id="compass-container">
            <div id="compass-circle">
                <div class="compass-direction north">N</div>
                <div class="compass-direction east">E</div>
                <div class="compass-direction south">S</div>
                <div class="compass-direction west">W</div>
                <div class="compass-subdirection" style="top: 15%; left: 50%; transform: translate(-50%, 0);">0¬∞</div>
                <div class="compass-subdirection" style="top: 50%; right: 15%; transform: translate(0, -50%);">90¬∞</div>
                <div class="compass-subdirection" style="bottom: 15%; left: 50%; transform: translate(-50%, 0);">180¬∞</div>
                <div class="compass-subdirection" style="top: 50%; left: 15%; transform: translate(0, -50%);">270¬∞</div>
                <canvas id="compass-ticks"></canvas>
                <div id="compass-center"></div>
            </div>
            <div id="checkpoint-markers"></div>
            <div id="compass-needle">
                <div class="needle-north"></div>
                <div class="needle-south"></div>
            </div>
        </div>
        <div id="distance-bar-container">
            <div id="distance-bar-label">
                <span>0m</span>
                <span id="max-distance-label">---m</span>
            </div>
            <div id="distance-bar"></div>
        </div>
    </div>
    
    <div id="controls">
        <button class="button button-primary" id="get-location-btn">
            üìç ÁèæÂú®Âú∞„ÇíÂèñÂæó
        </button>
        <button class="button button-primary" id="photo-btn">
            üì∑ ÂÜôÁúü„ÇíÊíÆÂΩ±
        </button>
        <input type="file" id="photo-input" accept="image/*" capture="environment">
        <button class="button button-success" id="check-button" disabled>
            ‚úì „ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„ÉàÁ¢∫Ë™ç
        </button>
        <button class="button" style="background: #48bb78; color: white; margin-top: 15px;" id="tracking-button">
            ‚ñ∂Ô∏è ËªåË∑°Ë®òÈå≤„ÇíÈñãÂßã
        </button>
        <button class="button" style="background: #e53e3e; color: white; margin-top: 20px;" id="clear-button">
            üóëÔ∏è „Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà
        </button>
    </div>
    
    <div id="info">
        <h3 style="margin-bottom: 10px; color: #2d3748;">üìä ÁèæÂú®„ÅÆÁä∂Ê≥Å</h3>
        <div class="info-item">
            <span class="info-label">Êé•Á∂öÁä∂ÊÖã</span>
            <span class="info-value" id="online-status">Á¢∫Ë™ç‰∏≠...</span>
        </div>
        <div class="info-item">
            <span class="info-label">PWAÁä∂ÊÖã</span>
            <span class="info-value" id="pwa-status">Á¢∫Ë™ç‰∏≠...</span>
        </div>

        <div class="info-item">
            <span class="info-label">‰ΩçÁΩÆÊÉÖÂ†±</span>
            <span class="info-value" id="gps-status">Êú™ÂèñÂæó</span>
        </div>
        <div class="info-item">
            <span class="info-label">GPSÁ≤æÂ∫¶</span>
            <span class="info-value" id="gps-accuracy">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">ÊíÆÂΩ±ÂÜôÁúü</span>
            <span class="info-value" id="photo-count">0Êûö</span>
        </div>
        <div class="info-item">
            <span class="info-label">ËªåË∑°„Éù„Ç§„É≥„Éà</span>
            <span class="info-value" id="track-count">0ÂÄã</span>
        </div>
        <div class="info-item">
            <span class="info-label">„ÇØ„É™„Ç¢Êï∞</span>
            <span class="info-value" id="cleared-count">0 / 5</span>
        </div>
    </div>
    
    <div id="checkpoint-list">
        <h3 style="margin-bottom: 10px; color: #2d3748;">üìç „ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà</h3>
        <div id="checkpoints"></div>
    </div>
    
    <div id="photo-gallery">
        <h3 style="margin-bottom: 10px; color: #2d3748;">üì∑ ÊíÆÂΩ±„Åó„ÅüÂÜôÁúü</h3>
        <div class="photo-grid" id="photo-grid"></div>
    </div>
    
    <div id="debug">
        <strong>üõ† „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞</strong>
        <div id="debug-log"></div>
    </div>
    
    <!-- ÂÜôÁúü„É¢„Éº„ÉÄ„É´ -->
    <div id="photo-modal" class="photo-modal">
        <span class="photo-modal-close">&times;</span>
        <img id="modal-image" src="" alt="Êã°Â§ßË°®Á§∫">
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Service WorkerÁôªÈå≤
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        debugLog('‚úÖ Service WorkerÁôªÈå≤ÊàêÂäü');
                        console.log('SW registered: ', registration);
                    })
                    .catch((error) => {
                        debugLog('‚ùå Service WorkerÁôªÈå≤Â§±Êïó: ' + error.message);
                        console.log('SW registration failed: ', error);
                    });
            });
        }
        
        // PWA„Ç§„É≥„Çπ„Éà„Éº„É´„Éó„É≠„É≥„Éó„Éà
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // „Ç§„É≥„Çπ„Éà„Éº„É´„Éê„Éä„Éº„ÇíË°®Á§∫
            const banner = document.getElementById('install-banner');
            if (banner && !window.matchMedia('(display-mode: standalone)').matches) {
                banner.style.display = 'block';
            }
            
            debugLog('üì± PWA„Ç§„É≥„Çπ„Éà„Éº„É´ÂèØËÉΩ');
        });
        
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let map;
        let currentPositionMarker;
        let currentPosition = null;
        let checkpoints = [];
        let completedCheckpoints = new Set();
        let photos = [];
        let startTime = Date.now();
        let timerInterval;
        let isOnline = navigator.onLine;
        let remainingTime = 120 * 60; // 2ÊôÇÈñìÔºàÁßíÔºâ
        let trackingEnabled = true; // ËªåË∑°Ë®òÈå≤„ÅÆ„Ç™„É≥/„Ç™„Éï
        let trackingInterval = null;
        let trackPoints = []; // ËªåË∑°„Éù„Ç§„É≥„Éà
        let trackPolyline = null; // Âú∞Âõ≥‰∏ä„ÅÆËªåË∑°Á∑ö
        let compassSupported = false; // „Ç≥„É≥„Éë„ÇπÊ©üËÉΩ„ÅÆ„Çµ„Éù„Éº„ÉàÁä∂Ê≥Å
        let currentHeading = 0; // ÁèæÂú®„ÅÆÊñπ‰Ωç
        let rotationTotal = 0; // Á¥ØÁ©çÂõûËª¢ËßíÂ∫¶Ôºà„Çπ„É†„Éº„Ç∫„Å™ÂõûËª¢Áî®Ôºâ
        let currentView = 'map'; // ÁèæÂú®„ÅÆ„Éì„É•„ÉºÔºàmap/compassÔºâ
        let activeTooltip = null; // ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆ„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó
        let tooltipTimeout = null; // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÅÆËá™ÂãïÈùûË°®Á§∫„Çø„Ç§„Éû„Éº
        let compassCalibrated = false; // Á£ÅÊ∞ó„Çª„É≥„Çµ„Éº„ÅÆËºÉÊ≠£Áä∂ÊÖã
        let usingAbsoluteOrientation = false; // Áµ∂ÂØæÊñπ‰Ωç„Çí‰ΩøÁî®„Åó„Å¶„ÅÑ„Çã„Åã
        let compassContainerSize = 400; // „Ç≥„É≥„Éë„Çπ„Ç≥„É≥„ÉÜ„Éä„ÅÆ„Çµ„Ç§„Ç∫ÔºàÂãïÁöÑ„Å´Êõ¥Êñ∞Ôºâ
        let resizeTimer = null; // „É™„Çµ„Ç§„Ç∫„Ç§„Éô„É≥„Éà„ÅÆ„Éá„Éê„Ç¶„É≥„ÇπÁî®„Çø„Ç§„Éû„Éº
        
        // „ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà„ÅÆ„Çµ„É≥„Éó„É´„Éá„Éº„ÇøÔºàÁ¶èÂ≥∂ÁúåÂçó‰ºöÊ¥•Áî∫Áî∞Â≥∂ÈßÖÂë®Ëæ∫Ôºâ
        const sampleCheckpoints = [
            { id: 1, name: "‰ºöÊ¥•Áî∞Â≥∂ÈßÖ", lat: 37.20329853, lng: 139.77424063, points: 10 },
            { id: 5, name: "Áî∞Â≥∂ÈÉµ‰æøÂ±Ä", lat: 37.20304087405265, lng: 139.77286576693686, points: 15 },
            { id: 3, name: "Âçó‰ºöÊ¥•Áî∫ÂΩπÂ†¥", lat: 37.200710699416376, lng: 139.77372578165173, points: 20 },
            { id: 4, name: "Êóß‰ºöÊ¥•Áî∞Â≥∂Á•áÂúí‰ºöÈ§®", lat: 37.205534721685595, lng: 139.77515747555398, points: 25 },
            { id: 7, name: "‰∏∏Â±±ÂÖ¨Âúí", lat: 37.20270904301629, lng: 139.76594854526823, points: 30 },
            { id: 8, name: "„Å≥„Çè„ÅÆ„Åã„ÅíÈÅãÂãïÂÖ¨ÂúíËäùÁîüÂ∫ÉÂ†¥", lat: 37.205439950626705, lng: 139.7619837579642, points: 35 },
            { id: 2, name: "„Å≥„Çè„ÅÆ„Åã„ÅíÂÖ¨Âúí", lat: 37.19933810720546, lng: 139.76057080171373, points: 40 },
            { id: 6, name: "„Åü„Åò„ÅæÂÖ¨Âúí", lat: 37.211615192715506, lng: 139.78760153630893, points: 45 }
        ];
        
        // LocalStorage„ÅÆ„Ç≠„Éº
        const STORAGE_KEY = 'rogaining_data';
        
        // PWAÁä∂ÊÖã„ÅÆÁ¢∫Ë™ç
        function checkPWAStatus() {
            const pwaStatusEl = document.getElementById('pwa-status');
            if (!pwaStatusEl) return;
            
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                pwaStatusEl.textContent = '‚úÖ „Ç§„É≥„Çπ„Éà„Éº„É´Ê∏à„Åø';
                pwaStatusEl.style.color = '#48bb78';
                debugLog('PWA„É¢„Éº„Éâ„ÅßÂÆüË°å‰∏≠');
            } else {
                pwaStatusEl.textContent = '„Éñ„É©„Ç¶„Ç∂„É¢„Éº„Éâ';
                pwaStatusEl.style.color = '#718096';
            }
        }
        
        // ÂÜôÁúü„ÇíÂúßÁ∏Æ„Åó„Å¶Base64Âåñ
        function compressImage(file, maxWidth = 1280, quality = 0.6) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressed = canvas.toDataURL('image/jpeg', quality);
                        const sizeKB = (compressed.length * 0.75 / 1024).toFixed(1);
                        debugLog(`ÂÜôÁúü„ÇíÂúßÁ∏Æ„Åó„Åæ„Åó„Åü: ${sizeKB}KB`);
                        
                        resolve(compressed);
                    };
                    img.onerror = () => reject(new Error('ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'));
                    img.src = e.target.result;
                };
                reader.onerror = () => reject(new Error('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'));
                reader.readAsDataURL(file);
            });
        }
        
        // „Éá„Éº„Çø„ÇíLocalStorage„Å´‰øùÂ≠ò
        function saveToLocalStorage() {
            const data = {
                completedCheckpoints: Array.from(completedCheckpoints),
                photos: photos.map(p => ({
                    timestamp: p.timestamp,
                    position: p.position,
                    dataUrl: p.dataUrl
                })),
                currentPosition: currentPosition,
                remainingTime: remainingTime,
                startTime: startTime,
                trackPoints: trackPoints,
                trackingEnabled: trackingEnabled,
                lastSaved: new Date().toISOString()
            };
            
            try {
                const jsonStr = JSON.stringify(data);
                const sizeKB = (jsonStr.length / 1024).toFixed(1);
                localStorage.setItem(STORAGE_KEY, jsonStr);
                debugLog(`„Éá„Éº„Çø„ÇíLocalStorage„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü (${sizeKB}KB)`);
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    debugLog('„Ç®„É©„Éº: LocalStorage„ÅÆÂÆπÈáè„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
                    alert('‰øùÂ≠òÂÆπÈáè„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÂè§„ÅÑÂÜôÁúü„ÇíÂâäÈô§„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else {
                    debugLog('LocalStorage‰øùÂ≠ò„Ç®„É©„Éº: ' + e.message);
                }
            }
        }
        
        // LocalStorage„Åã„Çâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return false;
                
                const data = JSON.parse(saved);
                completedCheckpoints = new Set(data.completedCheckpoints || []);
                currentPosition = data.currentPosition;
                remainingTime = data.remainingTime || 120 * 60;
                startTime = data.startTime || Date.now();
                trackPoints = data.trackPoints || [];
                trackingEnabled = data.trackingEnabled !== undefined ? data.trackingEnabled : true;
                photos = data.photos || [];
                
                debugLog('LocalStorage„Åã„Çâ„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü');
                debugLog(`Âæ©ÂÖÉ: ${completedCheckpoints.size}ÂÄã„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà„ÇØ„É™„Ç¢Ê∏à„Åø`);
                debugLog(`Âæ©ÂÖÉ: ${photos.length}Êûö„ÅÆÂÜôÁúü`);
                debugLog(`Âæ©ÂÖÉ: ${trackPoints.length}ÂÄã„ÅÆËªåË∑°„Éù„Ç§„É≥„Éà`);
                
                return true;
            } catch (e) {
                debugLog('LocalStorageË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ' + e.message);
                return false;
            }
        }
        
        // „Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
        function clearLocalStorage() {
            if (confirm('‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Çã„Éá„Éº„Çø„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }
        
        // „Ç™„É≥„É©„Ç§„É≥/„Ç™„Éï„É©„Ç§„É≥Áä∂ÊÖã„ÅÆÁõ£Ë¶ñ
        function setupOnlineDetection() {
            window.addEventListener('online', () => {
                isOnline = true;
                debugLog('‚úÖ „Ç™„É≥„É©„Ç§„É≥„Å´Âæ©Â∏∞„Åó„Åæ„Åó„Åü');
                updateOnlineStatus();
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                debugLog('‚ö†Ô∏è „Ç™„Éï„É©„Ç§„É≥„É¢„Éº„Éâ„Åß„Åô');
                updateOnlineStatus();
            });
            
            updateOnlineStatus();
        }
        
        // „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖã„ÅÆË°®Á§∫Êõ¥Êñ∞
        function updateOnlineStatus() {
            const mapDiv = document.getElementById('map');
            const onlineStatusEl = document.getElementById('online-status');
            
            if (!isOnline) {
                mapDiv.style.opacity = '0.5';
                mapDiv.style.pointerEvents = 'none';
                if (onlineStatusEl) {
                    onlineStatusEl.textContent = '‚ö†Ô∏è „Ç™„Éï„É©„Ç§„É≥';
                    onlineStatusEl.style.color = '#e53e3e';
                }
            } else {
                mapDiv.style.opacity = '1';
                mapDiv.style.pointerEvents = 'auto';
                if (onlineStatusEl) {
                    onlineStatusEl.textContent = '‚úÖ „Ç™„É≥„É©„Ç§„É≥';
                    onlineStatusEl.style.color = '#48bb78';
                }
            }
        }
        
        // „É™„Çµ„Ç§„Ç∫„Éè„É≥„Éâ„É©Ôºà„Éá„Éê„Ç¶„É≥„Çπ‰ªò„ÅçÔºâ
        function handleResize() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                updateCompassContainerSize();
                if (currentView === 'compass') {
                    drawCompassTicks();
                    updateCompassDisplay();
                }
            }, 250);
        }
        
        // „Ç≥„É≥„Éë„Çπ„Ç≥„É≥„ÉÜ„Éä„ÅÆ„Çµ„Ç§„Ç∫„ÇíÊõ¥Êñ∞
        function updateCompassContainerSize() {
            const container = document.getElementById('compass-container');
            if (container) {
                compassContainerSize = container.offsetWidth;
                const canvas = document.getElementById('compass-ticks');
                if (canvas) {
                    canvas.width = compassContainerSize;
                    canvas.height = compassContainerSize;
                    drawCompassTicks();
                }
            }
        }
        
        // „Ç≥„É≥„Éë„Çπ„ÅÆÁõÆÁõõ„Çä„ÇíÊèèÁîª
        function drawCompassTicks() {
            const canvas = document.getElementById('compass-ticks');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const size = compassContainerSize;
            const centerX = size / 2;
            const centerY = size / 2;
            const radius = size / 2 - 20;
            
            ctx.clearRect(0, 0, size, size);
            
            for (let i = 0; i < 360; i++) {
                const angle = (i - 90) * Math.PI / 180;
                
                let tickLength;
                let tickWidth;
                let tickColor;
                
                if (i % 90 === 0) {
                    tickLength = 25;
                    tickWidth = 3;
                    tickColor = i === 0 ? '#c53030' : '#2d3748';
                } else if (i % 45 === 0) {
                    tickLength = 20;
                    tickWidth = 2;
                    tickColor = '#4a5568';
                } else if (i % 15 === 0) {
                    tickLength = 15;
                    tickWidth = 2;
                    tickColor = '#718096';
                } else if (i % 5 === 0) {
                    tickLength = 10;
                    tickWidth = 1;
                    tickColor = '#a0aec0';
                } else {
                    continue;
                }
                
                const startX = centerX + (radius - tickLength) * Math.cos(angle);
                const startY = centerY + (radius - tickLength) * Math.sin(angle);
                const endX = centerX + radius * Math.cos(angle);
                const endY = centerY + radius * Math.sin(angle);
                
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(endX, endY);
                ctx.strokeStyle = tickColor;
                ctx.lineWidth = tickWidth;
                ctx.lineCap = 'round';
                ctx.stroke();
            }
        }
        
        // ÁèæÂú®Âú∞ÂèñÂæó
        function getCurrentLocation() {
            debugLog('‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó„ÇíÈñãÂßã...');
            
            // HTTPS„ÉÅ„Çß„ÉÉ„ÇØÔºàlocalhost‰ª•Â§ñ„ÅßHTTP„ÅÆÂ†¥Âêà„ÅØË≠¶ÂëäÔºâ
            if (location.protocol === 'http:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                alert('HTTPS„Åß„Å™„ÅÑ„Åü„ÇÅ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\nHTTPSÊé•Á∂ö„Åß„Ç¢„ÇØ„Çª„Çπ„Åô„Çã„Åã„ÄÅPWA„Å®„Åó„Å¶„Ç§„É≥„Çπ„Éà„Éº„É´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                debugLog('„Ç®„É©„Éº: HTTPSÊé•Á∂ö„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            if (!navigator.geolocation) {
                alert('„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ‰ΩçÁΩÆÊÉÖÂ†±Ê©üËÉΩ„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
                debugLog('„Ç®„É©„Éº: Geolocation APIÈùûÂØæÂøú');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    debugLog(`‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÊàêÂäü: ${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)}`);
                    debugLog(`GPSÁ≤æÂ∫¶: ${currentPosition.accuracy.toFixed(1)}m`);
                    
                    if (currentPositionMarker) {
                        map.removeLayer(currentPositionMarker);
                    }
                    
                    currentPositionMarker = L.marker([currentPosition.lat, currentPosition.lng], {
                        icon: L.divIcon({
                            className: 'current-position-icon',
                            html: '<div style="background: #48bb78; border: 4px solid white; border-radius: 50%; width: 20px; height: 20px; box-shadow: 0 0 10px rgba(72, 187, 120, 0.6);"></div>',
                            iconSize: [20, 20]
                        })
                    }).addTo(map);
                    
                    L.circle([currentPosition.lat, currentPosition.lng], {
                        radius: currentPosition.accuracy,
                        color: '#48bb78',
                        fillColor: '#48bb78',
                        fillOpacity: 0.1,
                        weight: 1
                    }).addTo(map);
                    
                    map.setView([currentPosition.lat, currentPosition.lng], 15);
                    
                    document.getElementById('gps-status').textContent = 'ÂèñÂæóÊ∏à„Åø';
                    document.getElementById('gps-accuracy').textContent = `¬±${currentPosition.accuracy.toFixed(1)}m`;
                    document.getElementById('check-button').disabled = false;
                    
                    saveToLocalStorage();
                    highlightNearbyCheckpoints();
                },
                (error) => {
                    let errorMessage = '';
                    let debugMessage = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '‰ΩçÁΩÆÊÉÖÂ†±„ÅÆ‰ΩøÁî®„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ\n„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åß‰ΩçÁΩÆÊÉÖÂ†±„ÅÆ‰ΩøÁî®„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                            debugMessage = '‰ΩçÁΩÆÊÉÖÂ†±„ÅÆ‰ΩøÁî®„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„ÅüÔºàPERMISSION_DENIEDÔºâ';
                            // HTTPS„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆËøΩÂä†ÊÉÖÂ†±
                            if (location.protocol === 'http:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                                errorMessage += '\n\n‚ÄªHTTPS„Åß„Å™„ÅÑ„Åü„ÇÅ‰ΩçÁΩÆÊÉÖÂ†±„Åå‰ΩøÁî®„Åß„Åç„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ';
                                debugMessage += 'ÔºàHTTPÊé•Á∂ö„ÅÆ„Åü„ÇÅÔºâ';
                            }
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '‰ΩçÁΩÆÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\nGPS/‰ΩçÁΩÆ„Çµ„Éº„Éì„Çπ„ÅåÊúâÂäπ„Å´„Å™„Å£„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                            debugMessage = '‰ΩçÁΩÆÊÉÖÂ†±„ÅåÂà©Áî®‰∏çÂèØÔºàPOSITION_UNAVAILABLEÔºâ';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ\nÈõªÊ≥¢Áä∂Ê≥Å„ÅÆËâØ„ÅÑÂ†¥ÊâÄ„ÅßÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
                            debugMessage = '‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó„Çø„Ç§„É†„Ç¢„Ç¶„ÉàÔºàTIMEOUTÔºâ';
                            break;
                        default:
                            errorMessage = '‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ';
                            debugMessage = `‰∏çÊòé„Å™„Ç®„É©„ÉºÔºàcode: ${error.code}Ôºâ`;
                    }
                    alert(errorMessage);
                    debugLog(`„Ç®„É©„Éº: ${debugMessage}`);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
        
        // ÂÜôÁúüÊíÆÂΩ±Âá¶ÁêÜ
        async function handlePhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            debugLog(`ÂÜôÁúü„ÇíÊíÆÂΩ±„Åó„Åæ„Åó„Åü: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`);
            
            try {
                const compressedDataUrl = await compressImage(file, 1280, 0.6);
                
                photos.push({
                    timestamp: new Date().toISOString(),
                    position: currentPosition ? {...currentPosition} : null,
                    dataUrl: compressedDataUrl
                });
                
                document.getElementById('photo-count').textContent = `${photos.length}Êûö`;
                renderPhotoGallery();
                saveToLocalStorage();
                debugLog(`‰øùÂ≠ò„Åï„Çå„ÅüÂÜôÁúüÊï∞: ${photos.length}Êûö`);
            } catch (error) {
                debugLog(`ÂÜôÁúü„ÅÆÂá¶ÁêÜ„Å´Â§±Êïó: ${error.message}`);
                alert('ÂÜôÁúü„ÅÆÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
            
            event.target.value = '';
        }
        
        // Ëøë„Åè„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà„Çí„Éè„Ç§„É©„Ç§„Éà
        function highlightNearbyCheckpoints() {
            if (!currentPosition) return;
            
            checkpoints.forEach(cp => {
                const distance = calculateDistance(
                    currentPosition.lat, currentPosition.lng,
                    cp.lat, cp.lng
                );
                
                if (distance <= 150 && !completedCheckpoints.has(cp.id)) {
                    debugLog(`„ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà„Äå${cp.name}„Äç„ÅåËøë„Åè„Å´„ÅÇ„Çä„Åæ„ÅôÔºà${distance.toFixed(1)}mÔºâ`);
                }
            });
            
            renderCheckpoints();
        }
        
        // „ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„ÉàÁ¢∫Ë™ç
        function checkNearbyCheckpoints() {
            if (!currentPosition) {
                alert('ÂÖà„Å´ÁèæÂú®Âú∞„ÇíÂèñÂæó„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (photos.length === 0) {
                alert('ÂÖà„Å´ÂÜôÁúü„ÇíÊíÆÂΩ±„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            let foundCheckpoint = false;
            const checkpointThreshold = 100;
            
            checkpoints.forEach(cp => {
                if (completedCheckpoints.has(cp.id)) return;
                
                const distance = calculateDistance(
                    currentPosition.lat, currentPosition.lng,
                    cp.lat, cp.lng
                );
                
                if (distance <= checkpointThreshold) {
                    completedCheckpoints.add(cp.id);
                    foundCheckpoint = true;
                    
                    debugLog(`‚úì „ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà„Äå${cp.name}„Äç„Çí„ÇØ„É™„Ç¢ÔºÅÔºà${cp.points}ÁÇπÔºâ`);
                    alert(`üéâ „ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà„Äå${cp.name}„Äç„Çí„ÇØ„É™„Ç¢ÔºÅ\n+${cp.points}ÁÇπ`);
                    
                    updateScore();
                    renderCheckpoints();
                    saveToLocalStorage();
                }
            });
            
            if (!foundCheckpoint) {
                alert('Ëøë„Åè„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„ÇìÔºà100m‰ª•ÂÜÖ„Å´Êé•Ëøë„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ');
                debugLog('„ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
            }
        }
        
        // ÂÜôÁúü„ÇÆ„É£„É©„É™„Éº„ÇíË°®Á§∫
        function renderPhotoGallery() {
            const grid = document.getElementById('photo-grid');
            grid.innerHTML = '';
            
            if (photos.length === 0) {
                grid.innerHTML = '<p style="color: #718096; text-align: center; padding: 20px;">ÂÜôÁúü„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-thumbnail';
                div.onclick = () => openPhotoModal(photo.dataUrl);
                
                const img = document.createElement('img');
                img.src = photo.dataUrl;
                img.alt = `ÂÜôÁúü ${index + 1}`;
                
                const info = document.createElement('div');
                info.className = 'photo-info';
                const time = new Date(photo.timestamp).toLocaleTimeString('ja-JP', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                info.textContent = time;
                
                div.appendChild(img);
                div.appendChild(info);
                grid.appendChild(div);
            });
        }
        
        // ÂÜôÁúü„Çí„É¢„Éº„ÉÄ„É´„ÅßÊã°Â§ßË°®Á§∫
        function openPhotoModal(dataUrl) {
            const modal = document.getElementById('photo-modal');
            const modalImage = document.getElementById('modal-image');
            modalImage.src = dataUrl;
            modal.classList.add('active');
        }
        
        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closePhotoModal() {
            const modal = document.getElementById('photo-modal');
            modal.classList.remove('active');
        }
        
        // ËªåË∑°Ë®òÈå≤„ÇíÈñãÂßã
        function startTracking() {
            if (trackingInterval) return;
            
            debugLog('ËªåË∑°Ë®òÈå≤„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü');
            trackingEnabled = true;
            
            const trackPosition = () => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const point = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString()
                        };
                        
                        trackPoints.push(point);
                        debugLog(`ËªåË∑°Ë®òÈå≤: ${trackPoints.length}ÂÄãÁõÆ„ÅÆ„Éù„Ç§„É≥„ÉàÂèñÂæó`);
                        
                        currentPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        
                        if (currentPositionMarker) {
                            map.removeLayer(currentPositionMarker);
                        }
                        
                        currentPositionMarker = L.marker([currentPosition.lat, currentPosition.lng], {
                            icon: L.divIcon({
                                className: 'current-position-icon',
                                html: '<div style="background: #48bb78; border: 4px solid white; border-radius: 50%; width: 20px; height: 20px; box-shadow: 0 0 10px rgba(72, 187, 120, 0.6);"></div>',
                                iconSize: [20, 20]
                            })
                        }).addTo(map);
                        
                        document.getElementById('gps-status').textContent = 'ÂèñÂæóÊ∏à„Åø';
                        document.getElementById('gps-accuracy').textContent = `¬±${currentPosition.accuracy.toFixed(1)}m`;
                        
                        updateTrackPolyline();
                        renderCheckpoints();
                        highlightNearbyCheckpoints();
                        
                        document.getElementById('track-count').textContent = `${trackPoints.length}ÂÄã`;
                        
                        if (trackPoints.length % 5 === 0) {
                            saveToLocalStorage();
                        }
                    },
                    (error) => {
                        debugLog(`ËªåË∑°Ë®òÈå≤„Ç®„É©„Éº: ${error.message}`);
                    },
                    {
                        enableHighAccuracy: false,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            };
            
            debugLog('ÂàùÂõû‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...');
            trackPosition();
            
            trackingInterval = setInterval(() => {
                if (!trackingEnabled) return;
                trackPosition();
            }, 60000);
            
            updateTrackingButton();
        }
        
        // ËªåË∑°Ë®òÈå≤„ÇíÂÅúÊ≠¢
        function stopTracking() {
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            
            trackingEnabled = false;
            debugLog('ËªåË∑°Ë®òÈå≤„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü');
            saveToLocalStorage();
            updateTrackingButton();
            renderCheckpoints();
        }
        
        // ËªåË∑°Ë®òÈå≤„ÅÆ„Ç™„É≥/„Ç™„Éï„ÇíÂàá„ÇäÊõø„Åà
        function toggleTracking() {
            if (trackingEnabled) {
                stopTracking();
            } else {
                startTracking();
            }
        }
        
        // ËªåË∑°Ë®òÈå≤„Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateTrackingButton() {
            const button = document.getElementById('tracking-button');
            if (!button) return;
            
            if (trackingEnabled) {
                button.textContent = '‚è∏Ô∏è ËªåË∑°Ë®òÈå≤„ÇíÂÅúÊ≠¢';
                button.style.background = '#e53e3e';
            } else {
                button.textContent = '‚ñ∂Ô∏è ËªåË∑°Ë®òÈå≤„ÇíÈñãÂßã';
                button.style.background = '#48bb78';
            }
        }
        
        // Âú∞Âõ≥‰∏ä„Å´ËªåË∑°„ÇíË°®Á§∫
        function updateTrackPolyline() {
            if (!map) return;
            
            if (trackPolyline) {
                map.removeLayer(trackPolyline);
            }
            
            if (trackPoints.length >= 2) {
                const latLngs = trackPoints.map(p => [p.lat, p.lng]);
                trackPolyline = L.polyline(latLngs, {
                    color: '#667eea',
                    weight: 3,
                    opacity: 0.7
                }).addTo(map);
            }
        }
        
        // 2ÁÇπÈñì„ÅÆË∑ùÈõ¢„ÇíË®àÁÆó
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        // „ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà„É™„Çπ„ÉàË°®Á§∫
        function renderCheckpoints() {
            const container = document.getElementById('checkpoints');
            container.innerHTML = '';
            
            checkpoints.forEach(cp => {
                const div = document.createElement('div');
                div.className = 'checkpoint-item';
                
                if (completedCheckpoints.has(cp.id)) {
                    div.classList.add('completed');
                } else if (currentPosition) {
                    const distance = calculateDistance(
                        currentPosition.lat, currentPosition.lng,
                        cp.lat, cp.lng
                    );
                    if (distance <= 150) {
                        div.classList.add('near');
                    }
                }
                
                div.innerHTML = `
                    <div>
                        <div class="checkpoint-name">${completedCheckpoints.has(cp.id) ? '‚úì ' : ''}${cp.name}</div>
                        ${currentPosition ? `<div style="font-size: 12px; color: #718096; margin-top: 4px;">
                            ${calculateDistance(currentPosition.lat, currentPosition.lng, cp.lat, cp.lng).toFixed(0)}m${!trackingEnabled ? ' <span style="color: #e53e3e;">(Êõ¥Êñ∞ÂÅúÊ≠¢‰∏≠)</span>' : ''}
                        </div>` : ''}
                    </div>
                    <div class="checkpoint-points">${cp.points}ÁÇπ</div>
                `;
                
                container.appendChild(div);
            });
            
            document.getElementById('cleared-count').textContent = 
                `${completedCheckpoints.size} / ${checkpoints.length}`;
        }
        
        // „Çπ„Ç≥„Ç¢Êõ¥Êñ∞
        function updateScore() {
            let totalScore = 0;
            checkpoints.forEach(cp => {
                if (completedCheckpoints.has(cp.id)) {
                    totalScore += cp.points;
                }
            });
            
            document.getElementById('score').textContent = `ÂæóÁÇπ: ${totalScore}ÁÇπ`;
        }
        
        // „Çø„Ç§„Éû„Éº
        function startTimer(seconds) {
            remainingTime = seconds;
            
            const updateTimer = () => {
                const hours = Math.floor(remainingTime / 3600);
                const minutes = Math.floor((remainingTime % 3600) / 60);
                const secs = remainingTime % 60;
                
                document.getElementById('timer').textContent = 
                    `ÊÆã„ÇäÊôÇÈñì: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                
                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    alert('Âà∂ÈôêÊôÇÈñìÁµÇ‰∫ÜÔºÅ');
                    debugLog('Á´∂ÊäÄÁµÇ‰∫Ü');
                    saveToLocalStorage();
                }
                
                remainingTime--;
                
                if (remainingTime % 30 === 0) {
                    saveToLocalStorage();
                }
            };
            
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞
        function debugLog(message) {
            const log = document.getElementById('debug-log');
            const time = new Date().toLocaleTimeString('ja-JP');
            const line = document.createElement('div');
            line.className = 'debug-line';
            line.textContent = `[${time}] ${message}`;
            log.insertBefore(line, log.firstChild);
            
            while (log.children.length > 20) {
                log.removeChild(log.lastChild);
            }
        }
        
        // „Ç≥„É≥„Éë„ÇπÊ©üËÉΩ„ÅÆÂàùÊúüÂåñ
        function initCompass() {
            if (window.DeviceOrientationEvent) {
                debugLog('„Ç≥„É≥„Éë„ÇπÊ©üËÉΩ„Çí„ÉÅ„Çß„ÉÉ„ÇØ‰∏≠...');
                
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    compassSupported = true;
                    document.getElementById('tab-compass').style.display = 'block';
                    debugLog('„Ç≥„É≥„Éë„ÇπÊ©üËÉΩ„ÅåÂà©Áî®ÂèØËÉΩ„Åß„ÅôÔºàiOS„ÄÅË®±ÂèØ„ÅåÂøÖË¶ÅÔºâ');
                } else {
                    compassSupported = true;
                    document.getElementById('tab-compass').style.display = 'block';
                    debugLog('„Ç≥„É≥„Éë„ÇπÊ©üËÉΩ„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Åô');
                    startCompass();
                }
            } else {
                debugLog('„Ç≥„É≥„Éë„ÇπÊ©üËÉΩ„ÅØÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
            }
        }
        
        // „Ç≥„É≥„Éë„Çπ„ÅÆÈñãÂßã
        function startCompass() {
            if ('ondeviceorientationabsolute' in window) {
                window.addEventListener('deviceorientationabsolute', handleAbsoluteOrientation);
                usingAbsoluteOrientation = true;
                debugLog('„Ç≥„É≥„Éë„Çπ„ÇíÈñãÂßã„Åó„Åæ„Åó„ÅüÔºàÁµ∂ÂØæÊñπ‰Ωç„É¢„Éº„Éâ - Á£ÅÊ∞ó„Çª„É≥„Çµ„Éº‰ΩøÁî®Ôºâ');
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
                debugLog('„Ç≥„É≥„Éë„Çπ„ÇíÈñãÂßã„Åó„Åæ„Åó„ÅüÔºàÊ®ôÊ∫ñÊñπ‰Ωç„É¢„Éº„ÉâÔºâ');
            }
        }
        
        // Áµ∂ÂØæÊñπ‰Ωç„Éá„Éº„Çø„ÅÆÂá¶ÁêÜ
        function handleAbsoluteOrientation(event) {
            if (event.alpha !== null) {
                currentHeading = 360 - event.alpha;
                compassCalibrated = true;
                updateCompassDisplay();
            }
        }
        
        // iOS„Åß„ÅÆË®±ÂèØË¶ÅÊ±Ç
        async function requestCompassPermission() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') {
                        startCompass();
                        debugLog('„Ç≥„É≥„Éë„Çπ„ÅÆË®±ÂèØ„Åå‰ªò‰∏é„Åï„Çå„Åæ„Åó„Åü');
                        return true;
                    } else {
                        alert('„Ç≥„É≥„Éë„ÇπÊ©üËÉΩ„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØË®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô');
                        debugLog('„Ç≥„É≥„Éë„Çπ„ÅÆË®±ÂèØ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü');
                        return false;
                    }
                } catch (error) {
                    debugLog('„Ç≥„É≥„Éë„ÇπË®±ÂèØ„Ç®„É©„Éº: ' + error.message);
                    return false;
                }
            }
            return true;
        }
        
        // Êñπ‰Ωç„Éá„Éº„Çø„ÅÆÂá¶ÁêÜ
        function handleOrientation(event) {
            let heading = 0;
            
            if (event.webkitCompassHeading !== undefined) {
                heading = event.webkitCompassHeading;
                compassCalibrated = true;
            } else if (event.alpha !== null) {
                if (event.absolute === true) {
                    heading = 360 - event.alpha;
                    compassCalibrated = true;
                } else if (event.absolute === false) {
                    heading = 360 - event.alpha;
                    if (!compassCalibrated) {
                        debugLog('‚ö†Ô∏è Á£ÅÊ∞ó„Çª„É≥„Çµ„Éº„Åå‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºàÁõ∏ÂØæÊñπ‰Ωç„É¢„Éº„ÉâÔºâ');
                        compassCalibrated = false;
                    }
                } else {
                    heading = 360 - event.alpha;
                }
            }
            
            currentHeading = heading;
            updateCompassDisplay();
        }
        
        // „Ç≥„É≥„Éë„ÇπË°®Á§∫„ÅÆÊõ¥Êñ∞
        function updateCompassDisplay() {
            const compassCircle = document.getElementById('compass-circle');
            const headingDisplay = document.getElementById('heading-display');
            
            if (compassCircle) {
                let normalizedHeading = currentHeading % 360;
                if (normalizedHeading < 0) normalizedHeading += 360;
                
                let currentRotation = rotationTotal % 360;
                if (currentRotation < 0) currentRotation += 360;
                
                let diff = normalizedHeading - currentRotation;
                
                if (diff > 180) {
                    diff -= 360;
                } else if (diff < -180) {
                    diff += 360;
                }
                
                rotationTotal += diff;
                compassCircle.style.transform = `rotate(${rotationTotal}deg)`;
            }
            
            if (headingDisplay) {
                let displayText = `Êñπ‰Ωç: ${Math.round(currentHeading)}¬∞`;
                
                if (usingAbsoluteOrientation) {
                    displayText += ' üß≠';
                } else if (compassCalibrated === false) {
                    displayText += ' ‚ö†Ô∏è';
                }
                
                headingDisplay.textContent = displayText;
            }
            
            updateCheckpointMarkers();
        }
        
        // „ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà„Éû„Éº„Ç´„Éº„ÅÆÊõ¥Êñ∞
        function updateCheckpointMarkers() {
            if (!currentPosition) return;
            
            const markersContainer = document.getElementById('checkpoint-markers');
            if (!markersContainer) return;
            
            markersContainer.innerHTML = '';
            
            let distances = [];
            checkpoints.forEach(cp => {
                if (completedCheckpoints.has(cp.id)) return;
                const distance = calculateDistance(
                    currentPosition.lat, currentPosition.lng,
                    cp.lat, cp.lng
                );
                distances.push(distance);
            });
            
            if (distances.length === 0) return;
            
            const minDistance = Math.min(...distances);
            const maxDistance = Math.max(...distances);
            
            const centerPoint = compassContainerSize / 2;
            const radius = centerPoint * 0.85;
            
            checkpoints.forEach(cp => {
                if (completedCheckpoints.has(cp.id)) return;
                
                const distance = calculateDistance(
                    currentPosition.lat, currentPosition.lng,
                    cp.lat, cp.lng
                );
                
                const color = getDistanceColor(distance, minDistance, maxDistance);
                
                const bearing = calculateBearing(
                    currentPosition.lat, currentPosition.lng,
                    cp.lat, cp.lng
                );
                
                const relativeBearing = (bearing - currentHeading + 360) % 360;
                
                const marker = document.createElement('div');
                marker.className = 'checkpoint-marker';
                marker.textContent = cp.points;
                marker.style.background = color;
                
                const angle = (relativeBearing - 90) * Math.PI / 180;
                const x = centerPoint + radius * Math.cos(angle);
                const y = centerPoint + radius * Math.sin(angle);
                
                marker.style.left = x + 'px';
                marker.style.top = y + 'px';
                marker.style.transform = `rotate(${-rotationTotal}deg)`;
                
                marker.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const rect = marker.getBoundingClientRect();
                    const tooltipX = rect.left + rect.width / 2;
                    const tooltipY = rect.top;
                    showTooltip(`${cp.name}: ${Math.round(distance)}m`, tooltipX, tooltipY);
                });
                
                markersContainer.appendChild(marker);
            });
            
            updateDistanceBar(minDistance, maxDistance);
        }
        
        // Ë∑ùÈõ¢„Éê„Éº„ÅÆÊõ¥Êñ∞
        function updateDistanceBar(minDist, maxDist) {
            if (!currentPosition) return;
            
            const bar = document.getElementById('distance-bar');
            const maxLabel = document.getElementById('max-distance-label');
            
            if (!bar) return;
            
            bar.innerHTML = '';
            
            if (maxLabel) {
                maxLabel.textContent = `${Math.round(maxDist)}m`;
            }
            
            checkpoints.forEach(cp => {
                if (completedCheckpoints.has(cp.id)) return;
                
                const distance = calculateDistance(
                    currentPosition.lat, currentPosition.lng,
                    cp.lat, cp.lng
                );
                
                const color = getDistanceColor(distance, minDist, maxDist);
                
                const position = maxDist > minDist 
                    ? ((distance - minDist) / (maxDist - minDist)) * 100 
                    : 50;
                
                const marker = document.createElement('div');
                marker.className = 'distance-marker';
                if (completedCheckpoints.has(cp.id)) {
                    marker.classList.add('completed');
                }
                marker.textContent = cp.points;
                marker.style.background = color;
                marker.style.left = `${position}%`;
                marker.title = `${cp.name}: ${Math.round(distance)}m`;
                
                marker.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const rect = marker.getBoundingClientRect();
                    const tooltipX = rect.left + rect.width / 2;
                    const tooltipY = rect.top;
                    showTooltip(`${cp.name}: ${Math.round(distance)}m`, tooltipX, tooltipY);
                });
                
                bar.appendChild(marker);
            });
        }
        
        // Ë∑ùÈõ¢„Å´Âøú„Åò„ÅüËâ≤„ÇíË®àÁÆó
        function getDistanceColor(distance, minDist, maxDist) {
            if (maxDist === minDist) {
                return 'hsl(120, 80%, 50%)';
            }
            
            const normalized = (distance - minDist) / (maxDist - minDist);
            
            let hue;
            if (normalized <= 0.5) {
                hue = 240 - (120 * normalized * 2);
            } else {
                hue = 120 - (120 * (normalized - 0.5) * 2);
            }
            
            return `hsl(${hue}, 80%, 50%)`;
        }
        
        // „Ç´„Çπ„Çø„É†„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÅÆË°®Á§∫
        function showTooltip(text, x, y) {
            hideTooltip();
            
            const tooltip = document.createElement('div');
            tooltip.className = 'custom-tooltip';
            tooltip.textContent = text;
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
            
            document.body.appendChild(tooltip);
            activeTooltip = tooltip;
            
            clearTimeout(tooltipTimeout);
            tooltipTimeout = setTimeout(hideTooltip, 3000);
        }
        
        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÇíÈùûË°®Á§∫
        function hideTooltip() {
            if (activeTooltip) {
                document.body.removeChild(activeTooltip);
                activeTooltip = null;
            }
            clearTimeout(tooltipTimeout);
        }
        
        // 2ÁÇπÈñì„ÅÆÊñπ‰Ωç„ÇíË®àÁÆó
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            
            const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
            const x = Math.cos(œÜ1) * Math.sin(œÜ2) -
                      Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
            const Œ∏ = Math.atan2(y, x);
            
            return (Œ∏ * 180 / Math.PI + 360) % 360;
        }
        
        // „Çø„Éñ„ÅÆÂàá„ÇäÊõø„ÅàÔºà„Ç∑„É≥„Éó„É´ÁâàÔºâ
        async function switchTab(view, targetTab) {
            debugLog(`„Çø„ÉñÂàá„ÇäÊõø„Åà: ${currentView} ‚Üí ${view}`);
            
            // Âêå„Åò„Éì„É•„Éº„Å∏„ÅÆÂàá„ÇäÊõø„Åà„ÅØÁÑ°Ë¶ñ
            if (currentView === view) {
                debugLog('Âêå„Åò„Éì„É•„Éº„Åß„Åô');
                return;
            }
            
            // iOS„Åß„Ç≥„É≥„Éë„Çπ„Çø„Éñ„ÇíÂàù„ÇÅ„Å¶„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÂ†¥Âêà„ÄÅË®±ÂèØ„ÇíÊ±Ç„ÇÅ„Çã
            if (view === 'compass' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                const hasListeners = window.ondeviceorientation !== null;
                if (!hasListeners) {
                    try {
                        const granted = await requestCompassPermission();
                        if (!granted) {
                            debugLog('„Ç≥„É≥„Éë„ÇπË®±ÂèØ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü');
                            return;
                        }
                    } catch (error) {
                        debugLog(`„Ç≥„É≥„Éë„ÇπË®±ÂèØ„Ç®„É©„Éº: ${error.message}`);
                        return;
                    }
                }
            }
            
            // „Éì„É•„Éº„ÇíÊõ¥Êñ∞
            currentView = view;
            
            // „Çø„Éñ„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // „Éì„É•„Éº„ÅÆÂàá„ÇäÊõø„Åà
            const mapDiv = document.getElementById('map');
            const compassDiv = document.getElementById('compass-view');
            
            if (view === 'map') {
                if (mapDiv) mapDiv.style.display = 'block';
                if (compassDiv) compassDiv.style.display = 'none';
                debugLog('„Éû„ÉÉ„Éó„Éì„É•„Éº„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü');
            } else if (view === 'compass') {
                if (mapDiv) mapDiv.style.display = 'none';
                if (compassDiv) compassDiv.style.display = 'flex';
                // „Ç≥„É≥„Éë„ÇπË°®Á§∫„ÇíÊõ¥Êñ∞
                setTimeout(() => {
                    updateCompassContainerSize();
                    updateCompassDisplay();
                }, 100);
                debugLog('„Ç≥„É≥„Éë„Çπ„Éì„É•„Éº„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü');
            }
        }
        
        // ÂàùÊúüÂåñ
        function init() {
            debugLog('„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñÈñãÂßã');
            
            // LocalStorage„Åã„Çâ„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ
            const restored = loadFromLocalStorage();
            if (restored) {
                debugLog('ÂâçÂõû„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü');
            }
            
            // „Ç™„É≥„É©„Ç§„É≥/„Ç™„Éï„É©„Ç§„É≥Ê§úÁü•„ÅÆË®≠ÂÆö
            setupOnlineDetection();
            
            // PWAÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            checkPWAStatus();
            
            // Âú∞Âõ≥„ÅÆÂàùÊúüÂåñ
            map = L.map('map').setView([37.20329853, 139.77424063], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            debugLog('Âú∞Âõ≥„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü');
            
            // „ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà„ÅÆË®≠ÂÆö
            checkpoints = [...sampleCheckpoints];
            renderCheckpoints();
            
            // „ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà„Çí„Éû„ÉÉ„Éó„Å´Ë°®Á§∫
            checkpoints.forEach(cp => {
                const marker = L.marker([cp.lat, cp.lng], {
                    icon: L.divIcon({
                        className: 'custom-icon',
                        html: `<div style="background: ${completedCheckpoints.has(cp.id) ? '#48bb78' : '#667eea'}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${cp.points}</div>`,
                        iconSize: [30, 30]
                    })
                }).addTo(map);
                
                marker.bindPopup(`<strong>${cp.name}</strong><br>${cp.points}ÁÇπ${completedCheckpoints.has(cp.id) ? '<br>‚úÖ „ÇØ„É™„Ç¢Ê∏à„Åø' : ''}`);
            });
            
            // „Çø„Ç§„Éû„ÉºÈñãÂßã
            startTimer(remainingTime);
            
            // Âæ©ÂÖÉ„Åó„Åü‰ΩçÁΩÆÊÉÖÂ†±„Åå„ÅÇ„Çå„Å∞Âú∞Âõ≥„Å´Ë°®Á§∫
            if (currentPosition) {
                if (currentPositionMarker) {
                    map.removeLayer(currentPositionMarker);
                }
                
                currentPositionMarker = L.marker([currentPosition.lat, currentPosition.lng], {
                    icon: L.divIcon({
                        className: 'current-position-icon',
                        html: '<div style="background: #48bb78; border: 4px solid white; border-radius: 50%; width: 20px; height: 20px; box-shadow: 0 0 10px rgba(72, 187, 120, 0.6);"></div>',
                        iconSize: [20, 20]
                    })
                }).addTo(map);
                
                document.getElementById('gps-status').textContent = 'ÂèñÂæóÊ∏à„ÅøÔºàÂæ©ÂÖÉÔºâ';
                document.getElementById('gps-accuracy').textContent = `¬±${currentPosition.accuracy.toFixed(1)}m`;
                document.getElementById('check-button').disabled = false;
            }
            
            // „Çπ„Ç≥„Ç¢„ÇíÊõ¥Êñ∞
            updateScore();
            
            // ÂÜôÁúüÊï∞„ÇíÊõ¥Êñ∞
            document.getElementById('photo-count').textContent = `${photos.length}Êûö`;
            
            // ËªåË∑°„Éù„Ç§„É≥„ÉàÊï∞„ÇíÊõ¥Êñ∞
            document.getElementById('track-count').textContent = `${trackPoints.length}ÂÄã`;
            
            // ÂÜôÁúü„ÇÆ„É£„É©„É™„Éº„ÇíË°®Á§∫
            renderPhotoGallery();
            
            // ËªåË∑°„ÇíÂú∞Âõ≥„Å´Ë°®Á§∫
            if (trackPoints.length > 0) {
                updateTrackPolyline();
                debugLog(`ËªåË∑°„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü: ${trackPoints.length}„Éù„Ç§„É≥„Éà`);
            }
            
            // ËªåË∑°Ë®òÈå≤„ÇíÈñãÂßã
            if (trackingEnabled) {
                startTracking();
            }
            updateTrackingButton();
            
            // „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖã„ÇíË°®Á§∫
            updateOnlineStatus();
            
            debugLog('„ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà„ÇíÈÖçÁΩÆ„Åó„Åæ„Åó„Åü');
            
            // „Ç≥„É≥„Éë„ÇπÊ©üËÉΩ„ÅÆÂàùÊúüÂåñ
            initCompass();
            
            // „Ç≥„É≥„Éë„Çπ„Ç≥„É≥„ÉÜ„Éä„ÅÆ„Çµ„Ç§„Ç∫„ÇíÂàùÊúüÂåñ
            updateCompassContainerSize();
            
            // „É™„Çµ„Ç§„Ç∫„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
            window.addEventListener('resize', handleResize);
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
            setupEventListeners();
        }
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
        function setupEventListeners() {
            debugLog('„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆöÈñãÂßã');
            
            // „Çø„Éñ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÔºà„Éá„Éê„ÉÉ„Ç∞Âº∑ÂåñÁâàÔºâ
            const tabMap = document.getElementById('tab-map');
            const tabCompass = document.getElementById('tab-compass');
            
            // Ë¶ÅÁ¥†„ÅåÂ≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™ç
            if (!tabMap) {
                debugLog('„Ç®„É©„Éº: „Éû„ÉÉ„Éó„Çø„ÉñË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            if (!tabCompass) {
                debugLog('„Ç®„É©„Éº: „Ç≥„É≥„Éë„Çπ„Çø„ÉñË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            debugLog('„Çø„ÉñË¶ÅÁ¥†„ÇíÁô∫Ë¶ã„Åó„Åæ„Åó„Åü');
            
            // „Éù„Ç§„É≥„Çø„Éº„Ç§„Éô„É≥„Éà„Çí‰ΩøÁî®Ôºà„Çà„ÇäÊ±éÁî®ÁöÑÔºâ
            function handleMapTab(e) {
                e.stopPropagation();
                e.preventDefault();
                debugLog('„Éû„ÉÉ„Éó„Çø„Éñ„Ç§„Éô„É≥„ÉàÁô∫ÁÅ´');
                switchTab('map', tabMap);
            }
            
            function handleCompassTab(e) {
                e.stopPropagation();
                e.preventDefault();
                debugLog('„Ç≥„É≥„Éë„Çπ„Çø„Éñ„Ç§„Éô„É≥„ÉàÁô∫ÁÅ´');
                switchTab('compass', tabCompass);
            }
            
            // Ë§áÊï∞„ÅÆ„Ç§„Éô„É≥„Éà„Çø„Ç§„Éó„ÇíÁôªÈå≤ÔºàÊúÄ„ÇÇÁ¢∫ÂÆü„Å™ÊñπÊ≥ïÔºâ
            ['pointerup', 'click', 'touchend'].forEach(eventType => {
                tabMap.addEventListener(eventType, handleMapTab, { passive: false, capture: true });
                tabCompass.addEventListener(eventType, handleCompassTab, { passive: false, capture: true });
                debugLog(`${eventType}„Ç§„Éô„É≥„Éà„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü`);
            });
            
            // „Çø„Éñ„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
            debugLog(`„Éû„ÉÉ„Éó„Çø„Éñ„ÅÆpointer-events: ${window.getComputedStyle(tabMap).pointerEvents}`);
            debugLog(`„Ç≥„É≥„Éë„Çπ„Çø„Éñ„ÅÆpointer-events: ${window.getComputedStyle(tabCompass).pointerEvents}`);
        }
            
            // „Åù„ÅÆ‰ªñ„ÅÆ„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            const getLocationBtn = document.getElementById('get-location-btn');
            if (getLocationBtn) {
                getLocationBtn.addEventListener('click', getCurrentLocation);
            }
            
            const photoBtn = document.getElementById('photo-btn');
            if (photoBtn) {
                photoBtn.addEventListener('click', () => {
                    document.getElementById('photo-input').click();
                });
            }
            
            const photoInput = document.getElementById('photo-input');
            if (photoInput) {
                photoInput.addEventListener('change', handlePhoto);
            }
            
            const checkBtn = document.getElementById('check-button');
            if (checkBtn) {
                checkBtn.addEventListener('click', checkNearbyCheckpoints);
            }
            
            const trackingBtn = document.getElementById('tracking-button');
            if (trackingBtn) {
                trackingBtn.addEventListener('click', toggleTracking);
            }
            
            const clearBtn = document.getElementById('clear-button');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearLocalStorage);
            }
            
            // ÂÜôÁúü„É¢„Éº„ÉÄ„É´„ÅÆÈñâ„Åò„Çã„Éú„Çø„É≥
            const modalClose = document.querySelector('.photo-modal-close');
            if (modalClose) {
                modalClose.addEventListener('click', closePhotoModal);
            }
            
            const photoModal = document.getElementById('photo-modal');
            if (photoModal) {
                photoModal.addEventListener('click', (e) => {
                    if (e.target === photoModal) {
                        closePhotoModal();
                    }
                });
            }
            
            // PWA„Ç§„É≥„Çπ„Éà„Éº„É´„Éê„Éä„Éº
            const installBtn = document.getElementById('install-button');
            if (installBtn) {
                installBtn.addEventListener('click', async () => {
                    if (!deferredPrompt) return;
                    
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    debugLog(`PWA„Ç§„É≥„Çπ„Éà„Éº„É´ÁµêÊûú: ${outcome}`);
                    
                    if (outcome === 'accepted') {
                        document.getElementById('install-banner').style.display = 'none';
                    }
                    
                    deferredPrompt = null;
                });
            }
            
            const closeBannerBtn = document.getElementById('close-install-banner');
            if (closeBannerBtn) {
                closeBannerBtn.addEventListener('click', () => {
                    document.getElementById('install-banner').style.display = 'none';
                });
            }
            
            // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÈùûË°®Á§∫Áî®„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
            document.addEventListener('click', (e) => {
                if (activeTooltip && !e.target.classList.contains('checkpoint-marker') && 
                    !e.target.classList.contains('distance-marker')) {
                    hideTooltip();
                }
            });
        }
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂàùÊúüÂåñ
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
